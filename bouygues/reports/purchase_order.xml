<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="bouygues_purchase_order_report" inherit_id="purchase.report_purchaseorder_document">
            <xpath expr="//t[@t-foreach='o.order_line']" position="replace">
                <t t-set="product_line" t-value="o.order_line.filtered(lambda l: l.product_template_id.default_code != False)"/>
                <t t-set="note_line" t-value="o.order_line.filtered(lambda l: l.product_template_id.default_code == False)"/>
                <t t-foreach="product_line.sorted(key=lambda x: x.product_template_id.default_code, reverse=False)" t-as="line">
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>

                    <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                        <t t-if="not line.display_type">
                            <td name="td_internal_ref">
                                <span t-field="line.internal_ref"/>
                            </td>
                            <td name="td_supplier_ref">
                                <span t-field="line.supplier_ref"/>
                            </td>
                            <td id="product">
                                <span t-field="line.name"/>
                            </td>
                            <td name="td_taxes">
                                <span t-esc="', '.join(map(lambda x: x.name, line.taxes_id))"/>
                            </td>
                            <td class="text-center">
                                <span t-field="line.date_planned"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.product_qty"/>
                                <span t-field="line.product_uom.name" groups="uom.group_uom"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.price_unit"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.discount"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.price_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                            </td>
                        </t>
                        <t t-if="line.display_type == 'line_section'">
                            <td colspan="99" id="section">
                                <span t-field="line.name"/>
                            </td>
                            <t t-set="current_section" t-value="line"/>
                            <t t-set="current_subtotal" t-value="0"/>
                        </t>
                        <t t-if="line.display_type == 'line_note'">
                            <td colspan="99" id="note">
                                <span t-field="line.name"/>
                            </td>
                        </t>
                    </tr>
                    <t t-if="current_section and (line_last or o.order_line[line_index+1].display_type == 'line_section')">
                        <tr class="is-subtotal text-right">
                            <td colspan="99" id="subtotal">
                                <strong class="mr16">Subtotal</strong>
                                <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                            </td>
                        </tr>
                    </t>
                </t>
                    <t t-foreach="note_line" t-as="line">
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>

                    <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                        <t t-if="not line.display_type">
                            <td name="td_internal_ref">
                                <span t-field="line.internal_ref"/>
                            </td>
                            <td name="td_supplier_ref">
                                <span t-field="line.supplier_ref"/>
                            </td>
                            <td id="product">
                                <span t-field="line.name"/>
                            </td>
                            <td name="td_taxes">
                                <span t-esc="', '.join(map(lambda x: x.name, line.taxes_id))"/>
                            </td>
                            <td class="text-center">
                                <span t-field="line.date_planned"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.product_qty"/>
                                <span t-field="line.product_uom.name" groups="uom.group_uom"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.price_unit"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.discount"/>
                            </td>
                            <td class="text-right">
                                <span t-field="line.price_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                            </td>
                        </t>
                        <t t-if="line.display_type == 'line_section'">
                            <td colspan="99" id="section">
                                <span t-field="line.name"/>
                            </td>
                            <t t-set="current_section" t-value="line"/>
                            <t t-set="current_subtotal" t-value="0"/>
                        </t>
                        <t t-if="line.display_type == 'line_note'">
                            <td colspan="99" id="note">
                                <span t-field="line.name"/>
                            </td>
                        </t>
                    </tr>
                    <t t-if="current_section and (line_last or o.order_line[line_index+1].display_type == 'line_section')">
                        <tr class="is-subtotal text-right">
                            <td colspan="99" id="subtotal">
                                <strong class="mr16">Subtotal</strong>
                                <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                            </td>
                        </tr>
                    </t>
                </t>
            </xpath>
            <xpath expr="//th[@name='th_description']" position="before">
                <th name="th_internal_ref"><strong>Internal Reference</strong></th>
                <th name="th_internal_ref"><strong>Supplier Reference</strong></th>
            </xpath>
            <xpath expr="//th[@name='th_amount']" position="before">
                <th name="th_discount"><strong>Discount (%)</strong></th>
            </xpath>
            <xpath expr="//div[@t-if='o.date_order']" position="replace">
                <div t-if="o.create_date" class="col-3 bm-2">
                    <strong>Order Date:</strong>
                    <p t-field="o.create_date" class="m-0"/>
                </div>
                <div t-if="o.real_delivery_date" class="col-3 bm-2">
                    <strong>Real Delivery Date:</strong>
                    <p t-field="o.real_delivery_date" class="m-0"/>
                </div>
            </xpath>
            <xpath expr="//div[@id='informations']" position="after">
                <div class="row">
                    <div class="col-12">
                        <t t-if="o.warehouse_text_printed">
                            <div style="width: 100%; height: auto; border: 2px black solid;margin: 0px; text-align: center">
                                <t t-if="o.ditrl_warehouse">
                                    <p style="font-size:18px;" class="my-0 py-0"><span t-field="o.ditrl_text"/></p>
                                </t>
                                <t t-if="o.dichm_warehouse">
                                    <p style="font-size:18px;" class="my-0 py-0"><span t-field="o.dichm_text"/></p>
                                </t>
                                <t t-if="o.paqtl_warehouse">
                                    <p style="font-size:18px;" class="my-0 py-0"><span t-field="o.paqtl_text"/></p>
                                </t>
                               <t t-if="o.locd_warehouse">
                                    <p style="font-size:18px;" class="my-0 py-0"><span t-field="o.locd_text"/></p>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
                <br/>
                <br/>
            </xpath>
        </template>
    </data>
</odoo>
